stages:
  - code-check
  - docker-check
  - docker-build
  - docker-test

variables:
  TEST_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG 
  RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest 

flake8_code:
  stage: code-check
  image: python:3
  before_script:
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
  script:
    - flake8 --max-line-length=150 --extend-exclude=*.pyc,*__init__.py,./venv/*,./jasapp/rules/kubernetes/* ./
  only:
    changes:
      - ./*.py

docker-lint:
  stage: docker-check
  image: hadolint/hadolint:2.9.2-debian
  script:
    - hadolint Dockerfile
  only:
    changes:
      - Dockerfile

docker-build:
  stage: docker-build
  image: docker:24
  services:
    - docker:24.0.5-dind
  before_script: 
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY 
  script: 
    - docker build -t $TEST_IMAGE . 
    - docker push $TEST_IMAGE
  only:
    changes:
      - ./*.py
      - Dockerfile
      - .dockerignore
      - requirements.txt

docker-test: 
  stage: docker-test
  image: docker:24 
  services: 
    - docker:24.0.5-dind
  script:
    - docker run --rm $TEST_IMAGE --score --type dockerfile jasapp/examples/dockerfile/example.Dockerfile 
